<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Joiner Dashboard v2.3</title>
    <style>
        /* --- GRUNDEINSTELLUNGEN --- */
        :root {
            --bg-gradient-start: #00050f; 
            --bg-gradient-end: #000000;
            --card-bg: #121212;
            --input-bg: #0a0a0a;
            --accent-main: #005eff; 
            --accent-glow: rgba(0, 94, 255, 0.5);
            --text-color: #ffffff;
            --text-muted: #6e6e78;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
            color: var(--text-color);
            overflow-x: hidden;
            min-height: 100vh;
        }

        #fireCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.6; pointer-events: none; }

        .discord-btn {
            background: #5865F2; 
            color: white; border: none; padding: 15px 40px; border-radius: 5px;
            font-weight: bold; font-size: 16px; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 0 15px rgba(88, 101, 242, 0.3);
            text-transform: uppercase; letter-spacing: 1px; text-decoration: none;
        }
        .discord-btn:hover { background: #4752c4; transform: translateY(-2px); box-shadow: 0 0 25px rgba(88, 101, 242, 0.6); }

        /* --- NAVIGATION --- */
        nav {
            display: flex;
            justify-content: space-between; align-items: center;
            padding: 20px 40px; background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 94, 0, 0.1);
            position: relative; z-index: 10;
        }
        .logo-container { display: flex; flex-direction: column; }
        .logo {
            font-size: 22px; font-weight: 700; text-transform: uppercase; cursor: pointer;
            background: linear-gradient(45deg, #ff8c00, #ff0000);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(255, 69, 0, 0.4);
            user-select: none;
        }
        .slogan {
            font-size: 11px; color: #2ecc71; font-weight: 700; letter-spacing: 1.5px;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.6); margin-top: -2px;
        }

        .nav-links span, .nav-links a {
            margin-left: 25px; color: var(--text-muted); cursor: pointer;
            font-size: 14px; font-weight: 500; transition: 0.3s;
            text-decoration: none;
        }
        .nav-links span:hover, .nav-links span.active-nav, .nav-links a:hover { 
            color: var(--accent-main); text-shadow: 0 0 10px var(--accent-glow); 
        }
        
        .user-profile-nav { display: flex; align-items: center; gap: 10px; }
        .nav-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--accent-main); object-fit: cover; }

        /* --- DASHBOARD --- */
        .container { max-width: 1100px; margin: 60px auto; text-align: center; padding: 20px; display: block; }
        .page-section { display: none; animation: fadeIn 0.4s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CLEANER STATUS BOX */
        .system-info-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px 30px;
            display: inline-flex;
            gap: 40px;
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 16px;
            color: #ccc;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-top: 10px; }
        
        .card {
            background: var(--card-bg); border: 1px solid #1f1f1f; border-radius: 16px;
            padding: 30px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.5); transition: 0.3s;
        }
        .card-large { grid-column: span 3; padding: 50px; border: 1px solid rgba(255, 94, 0, 0.1); }

        /* FIRE BORDER ANIMATION - IMMER DA */
        @keyframes fireBorder {
            0% { box-shadow: 0 0 10px #0000ff, 0 0 20px #005eff; border-color: #005eff; }
            50% { box-shadow: 0 0 25px #005eff, 0 0 40px #00aeff; border-color: #00aeff; }
            100% { box-shadow: 0 0 10px #0000ff, 0 0 20px #005eff; border-color: #005eff; }
        }
        .fire-active {
            animation: fireBorder 2s infinite alternate;
            background: linear-gradient(45deg, #1a0500, #000);
        }

        .btn-main {
            background: var(--accent-main); color: #fff; border: none; padding: 14px 40px;
            border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer;
            box-shadow: 0 0 20px var(--accent-glow); transition: all 0.3s ease;
            margin-top: 20px; display: inline-flex; align-items: center; gap: 10px;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 0 35px var(--accent-main); }
        .btn-main:disabled { background: #333; box-shadow: none; cursor: not-allowed; opacity: 0.5; }

        .stat-box { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; }
        .stat-value { color: var(--accent-main); font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .stat-label { color: var(--text-muted); font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 600; }
        
        /* --- SLOTS --- */
        .slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 40px; }
        .slot-card { background: var(--card-bg); border: 1px solid #222; border-radius: 12px; padding: 25px; text-align: left; position: relative; transition: 0.3s; }
        .slot-card.active-slot { border-color: red; box-shadow: 0 0 15px rgba(255, 0, 0, 0.2); }
        .slot-card.my-slot { border-color: var(--accent-main); box-shadow: 0 0 15px var(--accent-glow); }
        
        .slot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .slot-badge { background: #6200ff; color: white; font-size: 10px; font-weight: bold; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; }
        .status-badge { color: #444; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .status-badge.active { color: red; text-shadow: 0 0 5px rgba(255, 0, 0, 0.5); }
        .status-badge.mine { color: var(--accent-main); text-shadow: 0 0 5px var(--accent-glow); }
        
        .slot-content { display: flex; flex-direction: column; gap: 10px; align-items: center; justify-content: center; height: 100px; color: var(--text-muted); }
        .user-avatar { width: 50px; height: 50px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; border: 2px solid #444; object-fit: cover; }
        .live-timer { font-family: monospace; font-size: 16px; color: white; font-weight: bold; }
        .empty-icon { font-size: 40px; color: #333; margin-bottom: 5px; }

        /* --- MODALS --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 2000; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); animation: fadeIn 0.3s ease;
        }
        .modal-card {
            background: #0b0b0b; border: 1px solid #222; width: 500px; border-radius: 20px;
            padding: 35px; text-align: center; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.9);
        }
        .close-btn { position: absolute; top: 20px; right: 25px; color: var(--text-muted); font-size: 24px; cursor: pointer; }
        .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 5px; color: white; }
        .modal-sub { color: var(--text-muted); font-size: 14px; margin-bottom: 30px; }

        /* --- CODE BOX --- */
        .code-box {
            background: #111; border: 1px solid #333; padding: 15px; border-radius: 8px;
            font-family: 'Consolas', monospace; font-size: 13px; color: #ccc; word-break: break-all;
            text-align: left; margin-bottom: 20px; max-height: 120px; overflow-y: auto; white-space: pre-wrap;
        }
        .copy-btn {
            background: #222; border: 1px solid #444; color: white; padding: 5px 10px;
            font-size: 10px; border-radius: 4px; cursor: pointer; position: absolute; right: 45px; margin-top: -55px;
        }
        .copy-btn:hover { background: var(--accent-main); border-color: var(--accent-main); }

        /* --- ADMIN LOCK --- */
        .admin-lock-visible {
            display: none;
            position: fixed; top: 100px; right: 20px; 
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; border: 1px solid #333;
            cursor: pointer; z-index: 9999; transition: 0.3s;
        }
        .admin-lock-visible:hover { background: #222; border-color: var(--accent-main); }

        /* --- PAYMENT STYLES --- */
        .input-group { text-align: left; margin-bottom: 20px; }
        .input-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; display: block; }
        .amount-input-wrapper {
            position: relative; background: var(--input-bg); border: 1px solid #333;
            border-radius: 8px; display: flex; align-items: center; padding: 0 15px;
        }
        .currency-symbol { color: var(--text-muted); font-size: 18px; }
        .amount-input { background: transparent; border: none; color: white; font-size: 18px; padding: 15px; width: 100%; outline: none; text-align: right; }
        
        .preset-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 30px; }
        .preset-btn { background: #161616; border: 1px solid #333; color: var(--text-muted); padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .preset-btn:hover, .preset-btn.selected { background: var(--accent-main); color: white; border-color: var(--accent-main); }
        
        .pay-btn { width: 100%; background: var(--accent-main); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 0 20px var(--accent-glow); margin-top: 10px;}
        .pay-btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        .payment-step-2 { display: none; }
        .crypto-address-box {
            background: #1a1a1a; padding: 15px; border-radius: 8px; word-break: break-all;
            font-family: monospace; color: var(--accent-main); border: 1px dashed #444;
            margin: 15px 0; font-size: 12px; cursor: pointer;
        }
        .qr-code { margin: 20px auto; background: white; padding: 10px; border-radius: 10px; width: 140px; height: 140px; }
        .qr-code img { width: 100%; height: 100%; }
        
        .timer-box { font-size: 24px; font-family: monospace; color: white; margin: 15px 0; font-weight: bold; }
        .status-msg { font-size: 12px; margin-top: 10px; color: #888; min-height: 20px;}
        .loading-spinner { display: inline-block; width: 10px; height: 10px; border: 2px solid #555; border-top: 2px solid var(--accent-main); border-radius: 50%; animation: spin 1s infinite linear; margin-right: 5px;}
        @keyframes spin {0%{transform: rotate(0deg)} 100%{transform: rotate(360deg)}}

        .total-price-display { display: flex; justify-content: space-between; border-top: 1px solid #333; padding-top: 15px; margin-bottom: 15px; font-size: 14px; }

        /* ADMIN STYLES */
        .admin-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .admin-danger { background: #d32f2f; border: none; color: white; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .admin-success { background: #2ecc71; border: none; color: white; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* ADMIN SAVE HACKEN */
        #adminSaveIndicator { 
            color: #2ecc71; font-weight: bold; font-family: monospace; opacity: 0; transition: opacity 0.5s; 
            margin-left: 10px; display: inline-block; 
        }

    </style>
</head>
<body>


    <canvas id="fireCanvas"></canvas>

    <nav id="navbar">
        <div class="logo-container">
            <div class="logo">üí† Pulse Joiner</div>
            <div class="slogan">ADMIN PANEL</div>
        </div>
        <div class="nav-links">
            <a href="/logout">Logout</a>
        </div>
        
        <div class="user-profile-nav">
            <div style="text-align:right; margin-left:15px;">
                <div id="nav-username" style="font-size:12px; font-weight:bold;">Loading...</div>
                <div style="font-size:10px; color:#666; cursor:pointer;" onclick="copyMyID()" title="Click to Copy ID">ID: <span id="nav-userid">...</span> üìã</div>
            </div>
            <img id="nav-avatar" class="nav-avatar" src="" alt="">
        </div>
    </nav>

    <div id="dashboard-section" class="container page-section">
        <h1>Welcome back, <span id="welcome-username" style="color:var(--accent-main);">User</span></h1>
        
        <div class="system-info-box">
            <div>STATUS: <span id="systemStatus" style="color:#2ecc71;">ONLINE</span></div>
            <div>BOTS RUNNING: <span id="botCount" style="color:var(--accent-main);">0</span></div>
        </div>

        <div class="dashboard-grid">
            <div class="card card-large">
                <h3 style="margin-top:0; color:white;">üìú Script Editor</h3>
                <p style="color:#888; font-size:13px; margin-bottom:15px;">Changes are saved automatically.</p>
                <textarea id="scriptEditor" style="width: 100%; height: 400px; background: #0a0a0a; color: white; border: 1px solid #333; border-radius: 8px; padding: 15px; font-family: 'Consolas', monospace;"></textarea>
                <button class="btn-main" onclick="saveScript()">Save Script</button>
                <span id="adminSaveIndicator">‚úì Saved</span>
            </div>
        </div>

    <script>
        // Fetch user info and script content on page load
        window.onload = async () => {
            try {
                // Fetch user data
                const userResponse = await fetch('/api/user'); // You'll need to create this endpoint
                if (userResponse.ok) {
                    const user = await userResponse.json();
                    document.getElementById('nav-username').textContent = user.username;
                    document.getElementById('nav-userid').textContent = user.id;
                    document.getElementById('nav-avatar').src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
                    document.getElementById('welcome-username').textContent = user.username;
                } else {
                    console.error('Failed to fetch user data');
                }

                // Fetch script content
                const scriptResponse = await fetch('/api/admin/get-script');
                if (scriptResponse.ok) {
                    const script = await scriptResponse.text();
                    document.getElementById('scriptEditor').value = script;
                } else {
                    console.error('Failed to fetch script');
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        };

        // Save script
        async function saveScript() {
            const scriptContent = document.getElementById('scriptEditor').value;
            try {
                const response = await fetch('/api/admin/save-script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ script: scriptContent }),
                });

                if (response.ok) {
                    const indicator = document.getElementById('adminSaveIndicator');
                    indicator.style.opacity = '1';
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                    }, 2000);
                } else {
                    alert('Failed to save script.');
                }
            } catch (error) {
                console.error('Error saving script:', error);
                alert('An error occurred while saving the script.');
            }
        }

        // Debounce save function
        let debounceTimeout;
        document.getElementById('scriptEditor').addEventListener('input', () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(saveScript, 1000); // Auto-save after 1 second of inactivity
        });

    </script>
</body>
</html>                <button class="preset-btn duration-btn" onclick="selectDuration(12, this)">12h</button>
            </div>
            <div class="total-price-display">
                <span>Total Cost:</span>
                <span id="buyCost" style="color:var(--accent-main); font-weight:bold;">$0.00</span>
            </div>
            <button class="pay-btn" id="confirmBuyBtn" onclick="buyHours()" disabled>Buy Now</button>
            <p id="buyError" style="color:red; font-size:12px; margin-top:10px; display:none;">Insufficient Funds or Slot already active!</p>
        </div>
    </div>



    <div id="scriptModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title" style="color:#2ecc71">‚úÖ Purchase Successful</div>
            <p class="modal-sub">Here is your Whitelist Script. Copy it and execute it:</p>
            
            <div class="code-box" id="scriptOutput">
                -- Generating Key...
            </div>
            <button class="copy-btn" onclick="copyScript()">COPY</button>

            <p style="font-size:12px; color:#666; margin-top:10px;">Warning: This key is linked to your account.</p>
            <button class="pay-btn" onclick="closeModal('scriptModal')">Close</button>
        </div>
    </div>

    <div id="adminLoginModal" class="modal-overlay">
        <div class="modal-card">
            <span class="close-btn" onclick="closeModal('adminLoginModal')">&times;</span>
            <div class="modal-title" style="color:red;">Admin Access</div>
            <input type="password" id="adminPass" placeholder="Enter Password" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:white; border-radius:5px; margin:20px 0;">
            <button class="pay-btn" onclick="verifyAdmin()" style="background:red;">Login</button>
        </div>
    </div>
    <div id="adminPanelModal" class="modal-overlay">
        <div class="modal-card">
            <span class="close-btn" onclick="closeModal('adminPanelModal')">&times;</span>
            <div class="modal-title">Admin Control <span id="adminSaveIndicator">‚úî SAVED</span></div>
            <div style="text-align:left; margin-top:20px;">
                
                <label class="input-label">Script Editor (Lua)</label>
                <textarea id="adminScriptEditor" style="width:100%; height:150px; background:#111; color:#0f0; font-family:monospace; padding:10px; border:1px solid #333; margin-bottom:15px;"></textarea>
                <button class="pay-btn" style="background:#005eff; margin-bottom:20px;" onclick="saveAdminScript()">Save Script</button>
                <hr style="border-color:#222; margin-bottom:20px;">

                <label class="input-label">Finder Status</label>
                <select id="adminFinderStatus" onchange="updateStatusAndBots()" style="width:100%; padding:10px; background:#111; color:white; border:1px solid #333; margin-bottom: 15px;">
                    <option value="ONLINE">ONLINE</option> <option value="OFFLINE">OFFLINE</option>
                </select>

                <label class="input-label">Bots Running</label>
                <input type="number" id="adminBotCount" oninput="updateStatusAndBots()" value="0" style="width:100%; padding:10px; background:#111; color:white; border:1px solid #333; margin-bottom: 20px;">

                <div class="admin-btn-group">
                    <button class="admin-danger" onclick="adminPause()">PAUSE ALL KEYS</button>
                    <button class="admin-success" onclick="adminUnpause()">UNPAUSE ALL KEYS</button>
                </div>

                <label class="input-label">HWID BAN (Discord ID)</label>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="text" id="adminBanInput" placeholder="Discord User ID" style="width:100%; padding:10px; background:#111; color:white; border:1px solid #333;">
                    <button class="admin-danger" onclick="adminBan()">BAN</button>
                </div>

                <label class="input-label">UNWHITELIST (Discord ID)</label>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="text" id="adminUnwhitelistInput" placeholder="Discord User ID" style="width:100%; padding:10px; background:#111; color:white; border:1px solid #333;">
                    <button class="admin-danger" onclick="adminUnwhitelist()">REMOVE</button>
                </div>

                <button class="pay-btn" style="background:#2ecc71; margin-top:10px;" onclick="adminAddBalance()">Admin: Add $100 Balance</button>

                <button class="pay-btn" style="background:#444; margin-top:10px;" onclick="adminResetMe()">Fix My Local Slot (Reset)</button>
            </div>
        </div>
    </div>



    <script>
        function debug(msg) {
            // Debug removed
        }

        // --- API INTEGRATION FOR DISCORD BOT ---
        // This handles the request from the Discord bot to verify users
        function handleApiRequest() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('api_key');
            const userId = urlParams.get('user_id');

            // SECRET KEY MUST MATCH THE BOT'S .ENV FILE
            const SECRET_KEY = "vision123"; 

            if (window.location.pathname.includes('/api/verify')) {
                document.body.innerHTML = ''; // Clear page
                document.body.style.backgroundColor = 'black';
                document.body.style.color = 'white';
                
                if (apiKey !== SECRET_KEY) {
                    document.body.innerText = JSON.stringify({ success: false, reason: "Invalid API Key" });
                    return;
                }

                if (!userId) {
                    document.body.innerText = JSON.stringify({ success: false, reason: "Missing user_id" });
                    return;
                }

                // FETCH DATA FROM GIST TO CHECK USER
                fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: { 'Authorization': `token ${GH_TOKEN}` }
                })
                .then(response => response.json())
                .then(data => {
                    if(!data.files) {
                        document.body.innerText = JSON.stringify({ success: false, reason: "Database Error" });
                        return;
                    }

                    let db = JSON.parse(data.files['database.json'].content);
                    let foundSlot = false;
                    let expiresAt = null;

                    // Check if user has an active slot
                    if (db.slots) {
                        for (let i = 1; i <= 8; i++) {
                            const slot = db.slots[i.toString()];
                            if (slot && slot.discordId === userId && slot.expires > (Date.now() / 1000)) {
                                foundSlot = true;
                                expiresAt = new Date(slot.expires * 1000).toISOString();
                                break;
                            }
                        }
                    }

                    if (foundSlot) {
                        document.body.innerText = JSON.stringify({ 
                            success: true, 
                            active: true, 
                            expiresAt: expiresAt 
                        });
                    } else {
                        document.body.innerText = JSON.stringify({ 
                            success: false, 
                            reason: "No active slot found" 
                        });
                    }
                })
                .catch(err => {
                    document.body.innerText = JSON.stringify({ success: false, reason: "Internal Error: " + err.message });
                });
                
                // Stop the rest of the page from loading
                throw new Error("API Mode");
            }
        }
        
        try {
            handleApiRequest();
        } catch(e) {
            if(e.message !== "API Mode") console.error(e);
        }
        // --- END API INTEGRATION ---

        // --- KONFIGURATION ---
        const GIST_ID = "bde3ce32513d62186cf3b292a5355c6e";
        
        // ***************************************************************
        // HIER IST DEIN TOKEN EINGEF√úGT:
        // ***************************************************************
        const GH_TOKEN = "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"; 

        const CLIENT_ID = "1459384900863135806"; 
const REDIRECT_URI = "https://pulsejoiner.online"; 
        const myLtcAddress = "LhxwXddC8UHjHcckaPY1RL6U39PtDa8KTP";

        // *** VARIABLES ***
        let balance = 0.00;
        let activeHours = 0;
        let selectedHours = 0;
        let currentUserName = "User";
        let currentUserId = "";
        let currentUserAvatar = "";
        let myActiveSlot = null;
        let myStoredKey = "";

        // --- INIT SLOTS ---
        // Removed global slotsContainer to prevent null reference if script runs early
        
        // --- DISCORD LOGIN & STARTUP ---
        window.onload = () => {
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const accessToken = fragment.get('access_token');

            if (accessToken) {
                fetchDiscordUser(accessToken);
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
            
            fetchSlots();
            setInterval(fetchSlots, 5000);
        };

        function startDiscordLogin() {
            const btn = document.querySelector('.discord-btn');
            if(btn) btn.innerText = "OPENING...";
            
            const url = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;
            
            // Open in new tab (Beaming to App/Browser)
            const newWindow = window.open(url, '_blank');
            
            // Reset button after a few seconds
            setTimeout(() => { 
                if(btn) btn.innerText = "LOGIN WITH DISCORD"; 
                if(!newWindow) alert("Please allow popups to login!");
            }, 3000);
        }

        async function fetchDiscordUser(token) {
            document.querySelector('.discord-btn').innerText = "VERIFYING...";
            try {
                const response = await fetch('https://discord.com/api/users/@me', {
                    headers: { authorization: `Bearer ${token}` }
                });
                const userData = await response.json();

                if (userData.username) {
                    currentUserName = userData.username;
                    currentUserId = userData.id;
                    currentUserAvatar = `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`;

                    document.getElementById('welcome-username').innerText = currentUserName;
                    document.getElementById('nav-username').innerText = currentUserName;
                    document.getElementById('nav-userid').innerText = currentUserId;
                    document.getElementById('nav-avatar').src = currentUserAvatar;

                    // *** SYNC WITH DATABASE (PERSISTENCE) ***
                    await saveUserProfile();
                    await syncUserData();

                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('navbar').style.display = 'flex';
                    document.getElementById('dashboard-section').style.display = 'block';
                    document.getElementById('adminLock').style.display = 'block';
                    
                    window.history.pushState("", document.title, window.location.pathname);
                } else {
                    alert("Login failed.");
                }
            } catch (error) { alert("API Error"); }
        }

        async function syncUserData() {
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: { 'Authorization': `token ${GH_TOKEN}` } 
                });
                const data = await response.json();
                
                if(!data.files) {
                    console.error("API ERROR:", data);
                    return;
                }

                let db = JSON.parse(data.files['database.json'].content);
                
                if(db.users && db.users[currentUserId]) {
                    const user = db.users[currentUserId];
                    balance = user.balance || 0;
                    myStoredKey = user.key || "";
                } else {
                    balance = 0;
                }
                updateUI();
                if(myStoredKey) updateViewScriptButton();
            } catch(e) { console.log("Sync Error", e); }
        }

        // --- GIST SLOT MANAGEMENT ---
        async function fetchDatabase() {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: { 'Authorization': `token ${GH_TOKEN}` } 
            });
            const data = await response.json();
            if(!data.files) throw new Error("No files in Gist");
            return JSON.parse(data.files['database.json'].content);
        }

        async function fetchSlots() {
            try {
                const db = await fetchDatabase();
                
                // 1. Determine My Slot Status First
                const slots = db.slots || {};
                let mySlotId = null;
                const nowSec = Date.now() / 1000;
                
                for (let i = 1; i <= 8; i++) {
                    const s = slots[i.toString()];
                    if (s && s.discordId === currentUserId && s.expires > nowSec) {
                        mySlotId = i;
                        break;
                    }
                }
                myActiveSlot = mySlotId;

                // 2. Update User Data (Balance, Expiry, Key)
                if (db.users && db.users[currentUserId]) {
                    const user = db.users[currentUserId];
                    balance = user.balance || 0;
                    
                    let remaining = 0;
                    if (user.expiresAt && user.expiresAt > Date.now()) {
                        remaining = ((user.expiresAt - Date.now()) / 3600000).toFixed(1);
                    }
                    activeHours = remaining;

                    // Display Key if active AND has slot
                    const mainCard = document.getElementById('mainCard');
                    if (activeHours > 0 && user.key && myActiveSlot) {
                        mainCard.innerHTML = `
                            <div style="color: #2ecc71; margin-bottom: 15px; font-size: 13px;">‚óè ACTIVE - SLOT #${myActiveSlot}</div>
                            <div style="font-size: 24px; margin-bottom: 10px; font-weight:bold;">${activeHours} Hours Left</div>
                            <div class="code-box" style="text-align:center; font-size:16px; color:var(--accent-main);">${user.key}</div>
                            <button class="copy-btn" style="position:relative; margin:0 auto; display:inline-block; margin-top:10px;" onclick="navigator.clipboard.writeText('${user.key}')">Copy Key</button>
                        `;
                        mainCard.classList.remove('fire-active');
                        mainCard.style.borderColor = "#2ecc71";
                        mainCard.style.boxShadow = "0 0 20px rgba(46, 204, 113, 0.2)";
                    } else {
                        // Reset to Purchase view if expired or no slot
                        mainCard.innerHTML = `
                            <div style="color: var(--text-muted); margin-bottom: 15px; font-size: 13px;">‚óè <span id="dashSlotStatus">NO ACTIVE SLOT</span></div>
                            <div style="font-size: 20px; margin-bottom: 25px;">Purchase Access</div>
                            <button class="btn-main" id="buyHoursBtnDashboard" onclick="openModal('purchaseModal')">‚ö° Buy Hours</button>
                        `;
                        mainCard.classList.add('fire-active');
                        mainCard.style.borderColor = ""; 
                        mainCard.style.boxShadow = "";
                    }
                }
                updateUI();

                // 3. Render Auctions
                const auctions = db.auctions || initAuctions(db);
                renderAuctions(auctions, db);
                
                // 4. Render Slots (1-6 Standard Only - Auctions are separate)
                const slotsContainer = document.getElementById('slotsContainer');
                if (slotsContainer) {
                    slotsContainer.innerHTML = "";
                    
                    for (let i = 1; i <= 8; i++) {
                        const slotData = slots[i.toString()];
                        let cardClass = "slot-card";
                        let badgeClass = "";
                        let badgeText = "Waiting";
                        let htmlContent = "";
                        let slotType = (i <= 6) ? "STANDARD" : "AUCTION";

                        if (slotData && slotData.expires > nowSec) {
                            // Occupied
                            const isMine = (currentUserId && slotData.discordId === currentUserId);
                            if (isMine) {
                                cardClass += " my-slot";
                                badgeClass = "mine";
                                badgeText = "YOUR SLOT";
                            } else {
                                cardClass += " active-slot";
                                badgeClass = "active";
                                badgeText = "Occupied";
                            }

                            const timeLeft = slotData.expires - nowSec;
                            const h = Math.floor(timeLeft / 3600);
                            const m = Math.floor((timeLeft % 3600) / 60);
                            htmlContent = `
                                <div class="user-avatar" style="background-image: url('${slotData.avatar || ''}'); background-color: #333;"></div>
                                <div style="font-weight:bold; color:white;">${slotData.user || "User"}</div>
                                <div class="live-timer">${h}h ${m}m</div>
                            `;
                        } else {
                            // Empty
                            badgeText = (i <= 6) ? "Open" : "Auction Only";
                            htmlContent = `
                                <div class="empty-icon" style="color:#2a2a2a;">‚àÖ</div>
                                <div style="color:#444; font-size:12px; font-weight:bold; letter-spacing:1px; text-transform:uppercase;">${slotType} SLOT</div>
                            `;
                        }

                        slotsContainer.innerHTML += `
                            <div class="${cardClass}">
                                <div class="slot-header">
                                    <span class="slot-badge">SLOT #${i}</span>
                                    <span class="status-badge ${badgeClass}">${badgeText}</span>
                                </div>
                                <div class="slot-content">${htmlContent}</div>
                            </div>
                        `;
                    }
                }
                
                // 5. Update Status
                const statusEl = document.getElementById('systemStatus');
                const botEl = document.getElementById('botCount');
                if(statusEl) {
                    statusEl.innerText = (db.status || "online").toUpperCase();
                    statusEl.style.color = db.status === "paused" || db.status === "OFFLINE" ? "red" : "#2ecc71";
                }
                if(botEl && db.botCount !== undefined) botEl.innerText = db.botCount;

            } catch (e) { 
                console.error("Sync Error", e);
            }
        }

        // function checkMyActiveSlot(slots) { ... } // Removed
        // function updateViewScriptButton() { ... } // Removed

        // --- AUCTION LOGIC ---
        function initAuctions(db) {
            return [
                { id: 0, currentBid: 4.00, bidder: null, endTime: null, active: true },
                { id: 1, currentBid: 4.00, bidder: null, endTime: null, active: true }
            ];
        }

        function renderAuctions(auctions, db) {
            const container = document.getElementById('auctionsContainer');
            if(!container) { debug("Auctions container missing"); return; }
            
            try {
                container.innerHTML = "";

                if(!auctions || auctions.length === 0) {
                     container.innerHTML = "<div style='color:red;'>No auctions found in data.</div>";
                     debug("Render: No auctions");
                     return;
                }

                auctions.forEach((auction, index) => {
                    let timeDisplay = "WAITING FOR BID";
                    
                    if (auction.endTime) {
                        const diff = auction.endTime - Date.now();
                        if (diff > 0) {
                            const m = Math.floor(diff / 60000);
                            const s = Math.floor((diff % 60000) / 1000);
                            timeDisplay = `${m}m ${s}s`;
                        } else {
                            timeDisplay = "ENDING...";
                        }
                    }

                    let bidderDisplay = auction.bidder ? (auction.bidder === currentUserId ? "YOU" : (db.users && db.users[auction.bidder]?.username || "User")) : "None";
                    let isWinning = (auction.bidder === currentUserId);
                    let cardClass = isWinning ? "slot-card my-slot" : "slot-card";
                    let nextBidRate = auction.currentBid + 1;

                    container.innerHTML += `
                    <div class="${cardClass}">
                        <div class="slot-header">
                            <span class="slot-badge" style="background:var(--accent-main)">AUCTION #${index + 1}</span>
                            <span class="status-badge ${isWinning ? 'mine' : ''}">${timeDisplay}</span>
                        </div>
                        <div class="slot-content" style="height:auto; align-items:flex-start; gap:5px;">
                            <div style="font-size:24px; color:white; font-weight:bold;">$${auction.currentBid.toFixed(2)}<span style="font-size:14px; color:#aaa;">/hr</span></div>
                            <div style="font-size:12px; color:#aaa; margin-bottom:5px;">Duration: <span style="color:white;">2 Hours</span></div>
                            
                            <div style="background:rgba(255,255,255,0.1); padding:5px; border-radius:4px; width:100%; margin-bottom:5px;">
                                <div style="font-size:10px; color:#aaa;">CURRENT WINNER</div>
                                <div style="font-size:14px; font-weight:bold; color:${isWinning ? '#2ecc71' : 'white'}">${bidderDisplay}</div>
                            </div>
                            
                            <div style="margin-top:10px; width:100%;">
                                <button class="pay-btn" style="padding:10px; font-size:14px;" onclick="placeBid(${index})" ${myActiveSlot ? 'disabled' : ''}>
                                    BID $${nextBidRate.toFixed(2)}/hr
                                    <div style="font-size:10px; opacity:0.7;">(Total: $${(nextBidRate * 2).toFixed(2)})</div>
                                </button>
                            </div>
                        </div>
                    </div>`;
                });
            } catch (e) {
                console.error("Render Auctions Error:", e);
                container.innerHTML = `<div style="color:red; font-size:12px;">Error rendering auctions: ${e.message}</div>`;
            }
        }

        async function placeBid(index) {
            if(!currentUserId) { alert("Please login first!"); return; }
            if(myActiveSlot) { alert("You already have an active slot!"); return; }

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                // 1. Fetch Fresh DB
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: { 'Authorization': `token ${GH_TOKEN}` }
                });
                const data = await response.json();
                let db = JSON.parse(data.files['database.json'].content);
                
                if(!db.auctions) db.auctions = initAuctions(db);
                const auction = db.auctions[index];
                
                // 2. Validate
                const newBidRate = auction.currentBid + 1;
                const totalCost = newBidRate * 2; // 2 Hours Fixed
                
                if(db.users[currentUserId].balance < totalCost) {
                    alert(`Insufficient Balance! You need $${totalCost.toFixed(2)}`);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                // 3. Refund Previous Bidder
                if(auction.bidder && db.users[auction.bidder]) {
                    const refundAmount = auction.currentBid * 2;
                    db.users[auction.bidder].balance += refundAmount;
                }

                // 4. Deduct My Balance
                db.users[currentUserId].balance -= totalCost;

                // 5. Update Auction
                auction.currentBid = newBidRate;
                auction.bidder = currentUserId;
                auction.endTime = Date.now() + 120000; // 2 minutes (Reset timer)

                // 6. Save
                await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `token ${GH_TOKEN}` },
                    body: JSON.stringify({ files: { 'database.json': { content: JSON.stringify(db, null, 2) } } })
                });

                // Update Local UI
                balance = db.users[currentUserId].balance;
                updateUI();
                fetchSlots(); // Refresh UI

            } catch(e) {
                console.error(e);
                alert("Bid Failed. Try again.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function checkAuctionFinalize(auctions, db) {
            // Client-side visual update only - Bot handles actual finalization
            // This function is kept as a placeholder if we need it later
        }

        // --- NAVIGATION & MODALS ---
        function showPage(pageId) {
            if(pageId === 'purchase') { 
                if(activeHours > 0) { alert("You already have an active subscription!"); return; }
                openModal('purchaseModal'); return; 
            }
            if(pageId === 'addfunds') { openModal('addFundsModal'); return; }
            
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-links span').forEach(el => el.classList.remove('active-nav'));
            
            if(pageId === 'dashboard') { 
                document.getElementById('dashboard-section').classList.add('active'); 
                document.getElementById('nav-dashboard').classList.add('active-nav');
                fetchSlots();
            } 

        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; if(id === 'addFundsModal') stopPaymentMonitor(); }
        function handleOutsideClick(e, id) { if(e.target === document.getElementById(id)) closeModal(id); }

        // --- BUY HOURS ---
        function selectDuration(hours, btn) {
            selectedHours = hours;
            const cost = hours * 4;
            document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('buyCost').innerText = "$" + cost.toFixed(2);
            document.getElementById('confirmBuyBtn').disabled = false;
        }

        // --- HELPER: ATOMIC DB UPDATE ---
        async function modifyDB(action) {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: { 'Authorization': `token ${GH_TOKEN}` }
            });
            const data = await response.json();
            let db = JSON.parse(data.files['database.json'].content);
            
            const result = action(db);
            // If action returns DB, save it. If false/null, abort.
            if(result) {
                await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `token ${GH_TOKEN}` },
                    body: JSON.stringify({ files: { 'database.json': { content: JSON.stringify(result, null, 2) } } })
                });
            }
            return result;
        }

        async function buyHours() {
            if(myActiveSlot) { alert("You already have an active slot!"); return; }

            const cost = selectedHours * 4;
            const buyBtn = document.getElementById('confirmBuyBtn');

            if(balance >= cost) {
                buyBtn.disabled = true; buyBtn.innerText = "Checking Slots...";
                try {
                    let userKey = "";
                    await modifyDB(db => {
                        // 1. Find Free Slot (1-6 Only)
                        let freeSlotId = null;
                        if (!db.slots) db.slots = {};
                        const now = Date.now() / 1000;
                        
                        for(let i=1; i<=6; i++) {
                            const s = db.slots[i.toString()];
                            if(!s || s.expires < now) {
                                freeSlotId = i;
                                break;
                            }
                        }

                        if (!freeSlotId) throw new Error("No Standard Slots (1-6) available!");

                        // 2. Check Balance
                        if(!db.users[currentUserId]) db.users[currentUserId] = {};
                        const userBal = db.users[currentUserId].balance || 0;
                        if(userBal < cost) throw new Error("Insufficient Balance");

                        // 3. Generate Key
                        if(!db.users[currentUserId].key) {
                            db.users[currentUserId].key = "BJ-" + Math.random().toString(36).substring(2, 8).toUpperCase();
                        }
                        userKey = db.users[currentUserId].key;
                        
                        // 4. Update User & Slot
                        const expiryTime = (Date.now() + (selectedHours * 3600000)); // ms
                        db.users[currentUserId].expiresAt = expiryTime;
                        db.users[currentUserId].balance = userBal - cost;
                        db.users[currentUserId].hwid = ""; 

                        db.slots[freeSlotId.toString()] = {
                            user: currentUserName,
                            avatar: currentUserAvatar,
                            discordId: currentUserId,
                            expires: expiryTime / 1000 // seconds
                        };

                        return db;
                    });

                    // Success
                    balance -= cost;
                    updateUI();
                    fetchSlots(); 
                    
                    closeModal('purchaseModal');
                    
                    const rawUrl = `${window.location.origin}/api/verify?key=${userKey}`;
                    const finalCode = `_G.Key="${userKey}"\nloadstring(game:HttpGet("${rawUrl}"))()`;
                    document.getElementById('scriptOutput').innerText = finalCode;
                    openModal('scriptModal');

                } catch (e) { 
                    console.error(e); 
                    alert("Transaction Error: " + e.message); 
                } finally { 
                    buyBtn.innerText = "Buy Now"; 
                    buyBtn.disabled = false; 
                }
            } else { 
                document.getElementById('buyError').style.display = 'block'; 
            }
        }

        function copyScript() {
            const text = document.getElementById('scriptOutput').innerText;
            navigator.clipboard.writeText(text).then(() => alert("Copied!")).catch(() => alert("Copy manually!"));
        }

        // --- RENTING LOGIC ---


        // --- PAYMENT LOGIC ---
        let paymentInterval = null;
        let expectedLtcAmount = 0;

        function setAmount(val) { document.getElementById('fundAmount').value = val.toFixed(2); }
        function manualCheck() { 
            const statusDiv = document.getElementById('paymentStatus');
            statusDiv.innerHTML = `<span class="loading-spinner"></span> Checking blockchain...`;
            checkBlockchain(true);
        }
        
        async function checkBlockchain(isManual = false) {
            try {
                const response = await fetch(`https://api.blockcypher.com/v1/ltc/main/addrs/${myLtcAddress}/full?limit=5`);
                if(!response.ok) throw new Error("API Limit");
                const data = await response.json();
                let found = false;
                if(data.txs) {
                    for(let tx of data.txs) {
                        const timeDiff = (Date.now() - new Date(tx.received).getTime()) / 60000;
                        if (timeDiff < 20) { 
                             let receivedVal = 0;
                             tx.outputs.forEach(out => { if(out.addresses.includes(myLtcAddress)) receivedVal += out.value; });
                             let receivedLTC = receivedVal / 100000000;
                             if (Math.abs(receivedLTC - expectedLtcAmount) < (expectedLtcAmount * 0.05) || receivedLTC >= expectedLtcAmount) {
                                 found = true; completePayment(); break;
                             }
                        }
                    }
                }
                const statusDiv = document.getElementById('paymentStatus');
                if(!found) { statusDiv.innerHTML = isManual ? `<span style='color:orange'>No matching payment found yet.</span>` : `<span class="loading-spinner"></span> Waiting...`; }
            } catch(e) { document.getElementById('paymentStatus').innerHTML = `<span style='color:red'>API Busy, retrying...</span>`; }
        }

        function completePayment() {
            stopPaymentMonitor();
            const usdAmount = parseFloat(document.getElementById('fundAmount').value);
            balance += usdAmount;
            
            // SAVE BALANCE TO DB (Persistence)
            modifyDB(db => {
                if(!db.users[currentUserId]) db.users[currentUserId] = {};
                db.users[currentUserId].balance = balance;
                return db;
            });

            updateUI();
            document.getElementById('paymentStatus').innerHTML = `<span style="color:#2ecc71;">‚úî Payment Received!</span>`;
            setTimeout(() => closeModal('addFundsModal'), 2000);
        }

        function stopPaymentMonitor() { if(paymentInterval) clearInterval(paymentInterval); }
        function startPayment() {
            const usd = parseFloat(document.getElementById('fundAmount').value);
            if(!usd || usd < 1) { alert("Min $1"); return; }
            document.getElementById('payment-step-1').style.display = 'none';
            document.getElementById('payment-step-2').style.display = 'block';
            document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${myLtcAddress}`;
            let timeRemaining = 1200; document.getElementById('timerDisplay').innerText = "20:00";
            fetch('https://api.binance.com/api/v3/ticker/price?symbol=LTCUSDT').then(r=>r.json()).then(d => {
                expectedLtcAmount = (usd / parseFloat(d.price)).toFixed(5);
                document.getElementById('cryptoAmountDisplay').innerText = expectedLtcAmount + " LTC";
            });
            paymentInterval = setInterval(() => {
                timeRemaining--; const m = Math.floor(timeRemaining / 60); const s = timeRemaining % 60;
                document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if(timeRemaining % 10 === 0) checkBlockchain(false);
                if(timeRemaining <= 0) stopPaymentMonitor();
            }, 1000);
        }
        function copyAddress() { navigator.clipboard.writeText(myLtcAddress); alert("Address Copied!"); }
        function updateUI() { document.getElementById('userBalance').innerText = "$" + balance.toFixed(2); document.getElementById('dashBalance').innerText = "$" + balance.toFixed(2); document.getElementById('dashHours').innerText = activeHours + "h"; }

        // --- ADMIN FUNKTIONEN ---
        function verifyAdmin() { if(document.getElementById('adminPass').value === "pulsejoinerelke321") { closeModal('adminLoginModal'); openModal('adminPanelModal'); } else alert("Denied"); }
        function updateAdminSettings() { } 

        async function saveAdminScript() {
            const content = document.getElementById('adminScriptEditor').value;
            if(!content) return alert("Script is empty!");

            try {
                const res = await fetch('/api/admin/save-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ secret: "vision123", content: content })
                });
                const data = await res.json();
                if(data.success) {
                    showAdminSave();
                } else {
                    alert("Error: " + data.message);
                }
            } catch(e) {
                alert("Save Failed: " + e.message);
            }
        }

        function adminAddBalance() { 
            balance += 100; 
            updateUI();
            // Try to save to DB if logged in as admin user
            modifyDB(db => {
                if(!db.users[currentUserId]) db.users[currentUserId] = {};
                db.users[currentUserId].balance = balance;
                return db;
            });
            alert("Added $100 & Saved!"); 
        }
        function adminResetMe() { localStorage.clear(); alert("Reset Done. Reloading..."); location.reload(); }
        
        function showAdminSave() {
            const el = document.getElementById('adminSaveIndicator');
            el.style.opacity = "1";
            setTimeout(() => { el.style.opacity = "0"; }, 2000);
        }

        function adminPause() { modifyDB(db => { db.status = "paused"; return db; }); }
        function adminUnpause() { modifyDB(db => { db.status = "online"; return db; }); }
        function adminBan() { const id = document.getElementById('adminBanInput').value; if(!id) return; modifyDB(db => { if(!db.blacklist) db.blacklist = []; db.blacklist.push(id); return db; }); }
        function adminUnwhitelist() { const id = document.getElementById('adminUnwhitelistInput').value; if(!id) return; modifyDB(db => { if(db.users[id]) delete db.users[id]; for(let sid in db.slots) if(db.slots[sid] && db.slots[sid].discordId === id) db.slots[sid] = null; return db; }); }
        function updateStatusAndBots() {
            const s = document.getElementById('adminFinderStatus').value;
            const c = document.getElementById('adminBotCount').value;
            modifyDB(db => { db.status = s; db.botCount = c; return db; });
        }

        // --- USER TRANSFER SYSTEM ---
        async function saveUserProfile() {
            if(!currentUserId) return;
            try {
                await modifyDB(db => {
                    if (!db.users) db.users = {};
                    if (!db.users[currentUserId]) db.users[currentUserId] = {};
                    
                    // Update profile data
                    db.users[currentUserId].username = currentUserName;
                    db.users[currentUserId].avatar = currentUserAvatar;
                    
                    // Initialize balance if new
                    if (db.users[currentUserId].balance === undefined) db.users[currentUserId].balance = 0;
                    
                    return db;
                });
            } catch (e) { console.error("Profile Save Error", e); }
        }

        function copyMyID() {
            if(currentUserId) {
                navigator.clipboard.writeText(currentUserId);
                alert("ID Copied: " + currentUserId);
            }
        }

        async function previewRecipient() {
            const id = document.getElementById('sendRecipientId').value.trim();
            const preview = document.getElementById('recipientPreview');
            const img = document.getElementById('previewAvatar');
            const name = document.getElementById('previewName');
            
            if(!id) { preview.style.display = 'none'; return; }
            if(id === currentUserId) { 
                preview.style.display = 'flex';
                img.src = currentUserAvatar;
                name.innerText = "You (Self Transfer)";
                return;
            }

            try {
                const db = await fetchDatabase();
                if(db.users && db.users[id]) {
                    const user = db.users[id];
                    preview.style.display = 'flex';
                    img.src = user.avatar || "https://cdn.discordapp.com/embed/avatars/0.png";
                    name.innerText = user.username || "Unknown User";
                } else {
                    preview.style.display = 'none';
                }
            } catch(e) { console.error(e); }
        }

        async function executeTransfer() {
            const id = document.getElementById('sendRecipientId').value.trim();
            const amount = parseFloat(document.getElementById('sendAmount').value);
            const btn = document.getElementById('btnTransfer');
            
            if(!id) { alert("Enter Recipient ID"); return; }
            if(!amount || amount <= 0) { alert("Enter Valid Amount"); return; }
            if(id === currentUserId) { alert("Cannot send to yourself."); return; }
            if(balance < amount) { alert("Insufficient Balance!"); return; }

            const originalText = btn.innerText;
            btn.innerText = "Sending...";
            btn.disabled = true;

            try {
                await modifyDB(db => {
                    if(!db.users[currentUserId] || db.users[currentUserId].balance < amount) {
                        throw new Error("Insufficient Funds");
                    }
                    if(!db.users[id]) {
                        throw new Error("Recipient not found in database. They must login first.");
                    }

                    db.users[currentUserId].balance -= amount;
                    if(!db.users[id].balance) db.users[id].balance = 0;
                    db.users[id].balance += amount;
                    
                    return db;
                });
                
                alert(`Successfully sent $${amount.toFixed(2)} to ${id}!`);
                closeModal('sendBalanceModal');
                syncUserData(); 
                
            } catch(e) {
                alert("Transfer Failed: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // --- FIRE BG ---
        const canvas = document.getElementById("fireCanvas"); const ctx = canvas.getContext("2d"); canvas.width = window.innerWidth; canvas.height = window.innerHeight; const particles = [];
        class Particle { constructor() { this.reset(); } reset() { this.x = Math.random() * canvas.width; this.y = canvas.height + Math.random() * 100; this.size = Math.random() * 2 + 0.5; this.speedY = Math.random() * 2 + 0.5; this.color = `rgba(0, ${Math.random() * 100 + 100}, 255, ${Math.random() * 0.5})`; } update() { this.y -= this.speedY; if (this.size > 0.1) this.size -= 0.01; if (this.y < 0 || this.size <= 0.1) this.reset(); } draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
        for(let i=0; i<70; i++) particles.push(new Particle());
        function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
        animate();
    </script>
</body>
</html>